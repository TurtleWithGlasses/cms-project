---
# Alertmanager configuration for the CMS Project.
# Set SLACK_WEBHOOK_URL in environment or replace the placeholder below.
#
# Start Alertmanager:
#   docker run -p 9093:9093 \
#     -v $(pwd)/monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml \
#     prom/alertmanager

global:
  resolve_timeout: 5m
  # Default Slack webhook (override per receiver)
  slack_api_url: "${SLACK_WEBHOOK_URL}"

templates: []

route:
  # Group alerts by name + severity so a single page covers all instances.
  group_by: [alertname, severity]
  group_wait: 30s        # Wait before sending the first notification
  group_interval: 5m     # How long to wait before re-grouping new alerts
  repeat_interval: 4h    # Re-send if still firing after this interval
  receiver: slack-warnings

  routes:
    # Critical alerts go to a dedicated high-urgency channel.
    - match:
        severity: critical
      receiver: slack-critical
      continue: true   # Also send to the default receiver

receivers:
  # All warnings/info → #cms-alerts
  - name: slack-warnings
    slack_configs:
      - channel: "#cms-alerts"
        send_resolved: true
        title: |-
          [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}]
          {{ .CommonLabels.alertname }}
        text: |-
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Since:* {{ .StartsAt | since }}
          {{ end }}

  # Critical alerts → #cms-critical (separate high-urgency channel)
  - name: slack-critical
    slack_configs:
      - channel: "#cms-critical"
        send_resolved: true
        title: ":rotating_light: CRITICAL: {{ .CommonLabels.alertname }}"
        text: |-
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Since:* {{ .StartsAt | since }}
          {{ end }}

# Inhibition rules prevent warning noise when a critical alert covers the same scope.
inhibit_rules:
  - source_match:
      severity: critical
    target_match:
      severity: warning
    equal: [alertname, instance]
