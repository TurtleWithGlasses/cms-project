# PostgreSQL configuration for CMS Project
# Tuned for WAL streaming replication + moderate production load

# ---------------------------------------------------------------------------
# Connection settings
# ---------------------------------------------------------------------------
listen_addresses = '*'
max_connections = 200
superuser_reserved_connections = 3

# ---------------------------------------------------------------------------
# Memory settings
# ---------------------------------------------------------------------------
shared_buffers = 512MB           # ~25% of available RAM (adjust per server)
work_mem = 4MB                   # Per sort/hash operation; 200 conn * 4 MB = 800 MB peak
maintenance_work_mem = 64MB
effective_cache_size = 1GB       # Hint to planner about OS buffer cache

# ---------------------------------------------------------------------------
# WAL / Replication settings
# ---------------------------------------------------------------------------
wal_level = replica              # Required for streaming replication
max_wal_senders = 5              # Allow up to 5 standby connections
wal_keep_size = 1GB              # Retain 1 GB of WAL segments for replicas
hot_standby = on                 # Allow read queries on standby servers
wal_log_hints = on               # Required for pg_rewind (point-in-time recovery)
archive_mode = off               # Enable and configure archive_command for PITR

# ---------------------------------------------------------------------------
# Checkpointing
# ---------------------------------------------------------------------------
checkpoint_completion_target = 0.9
checkpoint_timeout = 10min
max_wal_size = 2GB
min_wal_size = 512MB

# ---------------------------------------------------------------------------
# Query planner
# ---------------------------------------------------------------------------
random_page_cost = 1.1           # SSD-tuned (use 4.0 for spinning disks)
effective_io_concurrency = 200   # Concurrent I/O operations (SSD: 200, HDD: 2)
default_statistics_target = 100

# ---------------------------------------------------------------------------
# Logging (structured for Promtail/Loki ingestion)
# ---------------------------------------------------------------------------
log_destination = 'stderr'
logging_collector = off          # Let Docker capture stderr
log_min_duration_statement = 500 # Log queries taking > 500 ms
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d '
log_lock_waits = on
log_temp_files = 0
log_autovacuum_min_duration = 250ms

# ---------------------------------------------------------------------------
# Autovacuum
# ---------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_scale_factor = 0.02
autovacuum_analyze_scale_factor = 0.01
